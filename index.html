<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Race Results Extractor</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèÉ</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        header p {
            font-size: 1.1em;
            opacity: 0.95;
        }
        
        .control-panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .input-section {
            margin-bottom: 20px;
        }
        
        .input-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
        }
        
        .input-area {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.5;
            resize: vertical;
            transition: border-color 0.3s ease;
        }
        
        .input-area:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .button-row {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .btn-success {
            background: #48bb78;
            color: white;
        }
        
        .btn-success:hover {
            background: #38a169;
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background: #ed8936;
            color: white;
        }
        
        .btn-warning:hover {
            background: #dd6b20;
        }
        
        .format-selector {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
        }
        
        .format-selector select {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
        }
        
        .stats-bar {
            display: flex;
            gap: 30px;
            padding: 15px 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .stat {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
        }
        
        .stat-value {
            font-weight: 700;
            color: #333;
            font-size: 1.1em;
        }
        
        .table-container {
            background: white;
            border-radius: 12px;
            padding: 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .table-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-title {
            font-size: 1.3em;
            font-weight: 600;
        }
        
        .table-wrapper {
            max-height: 600px;
            overflow-y: auto;
            overflow-x: auto;
        }
        
        .results-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .results-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .results-table th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
            white-space: nowrap;
        }
        
        .results-table tbody tr {
            transition: background-color 0.2s ease;
        }
        
        .results-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .results-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .results-table tbody tr:nth-child(even) {
            background-color: #fafbfc;
        }
        
        .place-cell {
            font-weight: 700;
            color: #667eea;
            text-align: center;
        }
        
        .place-cell.gold {
            color: #f6ad55;
        }
        
        .place-cell.silver {
            color: #a0aec0;
        }
        
        .place-cell.bronze {
            color: #ed8936;
        }
        
        .bib-cell {
            font-family: 'Monaco', 'Menlo', monospace;
            color: #718096;
            text-align: center;
        }
        
        .name-cell {
            font-weight: 500;
            color: #2d3748;
        }
        
        .team-cell {
            color: #4a5568;
        }
        
        .time-cell {
            font-family: 'Monaco', 'Menlo', monospace;
            font-weight: 600;
            color: #2d3748;
        }
        
        .points-cell {
            text-align: center;
            font-weight: 600;
            color: #667eea;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #a0aec0;
        }
        
        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 20px;
        }
        
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #48bb78;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            font-weight: 600;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .error-message {
            color: #e53e3e;
            background: #fff5f5;
            border: 1px solid #feb2b2;
            padding: 10px 15px;
            border-radius: 6px;
            margin-top: 10px;
            display: none;
        }
        
        .hidden {
            display: none;
        }
        
        .table-wrapper::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        .table-wrapper::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .table-wrapper::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 5px;
        }
        
        .table-wrapper::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Race Results Extractor</h1>
            <p>Transform messy race results into beautiful, organized data - supports KarmaRush, RunSignup, MileSplit, and RunHigh</p>
        </header>

        <div class="control-panel">
            <div class="input-section">
                <label class="input-label">Paste Race Results Here</label>
                <textarea id="input" class="input-area" placeholder="Copy and paste race results from KarmaRush, RunSignup, MileSplit, or RunHigh...

RunHigh Example:
  509     2     2  Kendel Jones, 12          8:10.5   16:17.8    5:15  Elk Lake

KarmaRush Example:
1	Travis Furmanski
Cedar Crest [12] - 4570
14:53.8

RunSignup Example:
1    1    
A
Ariana
Akey
12    251    Mountain Vista High School    20:00.8    6:27/M"></textarea>
                <div id="inputError" class="error-message"></div>
            </div>
            
            <div class="button-row">
                <button class="btn btn-primary" onclick="extractResults()">
                    Extract Results
                </button>
                <button class="btn btn-secondary" onclick="loadSample()">
                    Load Sample
                </button>
                <button class="btn btn-warning" onclick="clearAll()">
                    Clear All
                </button>
                <button class="btn btn-success" onclick="copyAsSpreadsheet()">
                    Copy for Excel
                </button>
                
                <div class="format-selector">
                    <label for="delimiter">Export Format:</label>
                    <select id="delimiter">
                        <option value="tab">Tab (Excel/Sheets)</option>
                        <option value="csv">CSV</option>
                        <option value="pipe">Pipe (|)</option>
                    </select>
                </div>
            </div>
            
            <div class="stats-bar">
                <div class="stat">
                    <span class="stat-label">Total Results:</span>
                    <span id="rowCount" class="stat-value">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Platform:</span>
                    <span id="platform" class="stat-value">-</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Status:</span>
                    <span id="status" class="stat-value">Ready</span>
                </div>
            </div>
        </div>

        <div class="table-container">
            <div class="table-header">
                <div class="table-title">Extracted Results</div>
                <button class="btn btn-secondary" style="padding: 8px 16px;" onclick="copyTableData()">
                    Copy Table
                </button>
            </div>
            <div class="table-wrapper">
                <table class="results-table" id="resultsTable">
                    <thead>
                        <tr>
                            <th>Place</th>
                            <th>Bib</th>
                            <th>Name</th>
                            <th>Grade</th>
                            <th>Team</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="6" class="empty-state">
                                <div class="empty-state-icon">üìã</div>
                                <div>No results yet. Paste race data above and click "Extract Results"</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        let extractedResults = [];

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function showError(message) {
            const errorEl = document.getElementById('inputError');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            setTimeout(() => {
                errorEl.style.display = 'none';
            }, 5000);
        }

        function extractResults() {
            const input = document.getElementById('input').value;
            
            if (!input.trim()) {
                showError('Please paste race results into the input area');
                return;
            }

            document.getElementById('status').textContent = 'Processing...';
            extractedResults = [];

            try {
                const lines = input.trim().split('\n').map(line => line.trim()).filter(line => line);
                
                // Skip header content - find where results actually start
                // First, look for "Individuals" section or the all-results header (RunHigh format)
                let individualsIndex = -1;
                for (let i = 0; i < lines.length; i++) {
                    if (lines[i].match(/^Individuals$/i) ||
                        lines[i].match(/ID#\s+POINTS/i) ||
                        lines[i].match(/ID#\s+PLACE\s+SCORE\s+FINISHER/i) ||
                        lines[i].match(/^Top$/i)) {
                        individualsIndex = i;
                        break;
                    }
                }

                // Search for first data line (starting from Individuals section if found)
                const searchStart = individualsIndex >= 0 ? individualsIndex : 0;
                let startIndex = -1;

                for (let i = searchStart; i < lines.length; i++) {
                    const line = lines[i];
                    // Endurance Splits: "1    1    1164    Name..."
                    if (line.match(/^1\s+1\s+\d{3,4}\s+[A-Z]/i)) {
                        startIndex = i;
                        break;
                    }
                    // Space-delimited: "1 NAME (TEAM) ..." or multi-line with team on next line
                    if (line.match(/^1\s+[A-Z]+.*\([A-Z]{3,4}\)/i) ||
                        (line.match(/^1\s+[A-Z\s]+\s+[A-Z\s,]+\s+[MF]R?:/i) &&
                         i + 1 < lines.length &&
                         lines[i + 1].match(/^\([A-Z]{3,4}\)/i))) {
                        startIndex = i;
                        break;
                    }
                    // RunHigh: starts with whitespace and 3-4 digit number followed by more numbers
                    // Format: " 1668     1     1  Gabe Simkiss, 11..."
                    if (line.match(/^\s*\d{3,4}\s+\d+\s+\d+\s+\w/)) {
                        startIndex = i;
                        break;
                    }
                    // KarmaRush/other formats: line starting with place number
                    if (line.match(/^1(\t|$)/)) {
                        startIndex = i;
                        break;
                    }
                }

                if (startIndex === -1) {
                    showError('Could not find the start of race results. Make sure you copied the results table.');
                    document.getElementById('status').textContent = 'Error';
                    return;
                }
                
                const resultLines = lines.slice(startIndex);
                
                // Try to detect format
                let hasKarmaRushPattern = false;
                let hasRunSignupPattern = false;
                let hasMileSplitPattern = false;
                let hasRunHighPattern = false;
                
                let hasSpaceDelimitedPattern = false;
                let hasEnduranceSplitsPattern = false;

                for (let i = 0; i < Math.min(resultLines.length, 30); i++) {
                    // Endurance Splits format: "1    1    1164    Sofia Lauren Garza    Mission Sharyland    18:18.8    5:54/M"
                    if (resultLines[i].match(/^\d+\s+\d+\s+\d{3,4}\s+[A-Z]/i)) {
                        hasEnduranceSplitsPattern = true;
                        break;
                    }
                    // Space-delimited format: "1 EMILY GROSS (DUMA) DUMAS, TX F: 1 SO 1596 00:11:27.55..."
                    if (resultLines[i].match(/^\d+\s+[A-Z]+.*\([A-Z]{3,4}\).*[MF]R?:\s*\d+\s+(FR|SO|JR|SR|8th)/i)) {
                        hasSpaceDelimitedPattern = true;
                        break;
                    }
                    // Multi-line space-delimited: team on next line
                    if (resultLines[i].match(/^\d+\s+[A-Z\s]+\s+[A-Z\s,]+\s+[MF]R?:\s*\d+\s+(FR|SO|JR|SR|8th)/i) &&
                        i + 1 < resultLines.length &&
                        resultLines[i + 1].match(/^\([A-Z]{3,4}\)/i)) {
                        hasSpaceDelimitedPattern = true;
                        break;
                    }
                    // RunHigh: Look for pattern with ID# at start followed by place/score and name
                    // Format: " 1668     1     1  Gabe Simkiss, 11          8:11.2   16:13.7..."
                    if (resultLines[i].match(/^\d{3,4}\s+\d+\s+\d+\s+[A-Z]/i)) {
                        hasRunHighPattern = true;
                        break;
                    }
                    // KarmaRush
                    if (resultLines[i].match(/\[(\d{1,2}|fr|so|jr|sr)\]\s*-\s*\d+/i)) {
                        hasKarmaRushPattern = true;
                        break;
                    }
                    // MileSplit
                    if (resultLines[i].match(/Logo/i) || resultLines[i].match(/#\d+/)) {
                        hasMileSplitPattern = true;
                        break;
                    }
                    // RunSignup
                    if (resultLines[i].match(/^[A-Z]$/) && i + 2 < resultLines.length &&
                        resultLines[i+1].match(/^[A-Z][a-z]+$/) &&
                        resultLines[i+2].match(/^[A-Z][a-z]+$/)) {
                        hasRunSignupPattern = true;
                        break;
                    }
                }
                
                if (hasEnduranceSplitsPattern) {
                    // Process Endurance Splits format
                    for (let i = 0; i < resultLines.length; i++) {
                        let result = parseEnduranceSplitsFormat(resultLines[i]);
                        if (result) {
                            extractedResults.push(result);
                        }
                    }
                } else if (hasSpaceDelimitedPattern) {
                    // Process space-delimited format
                    for (let i = 0; i < resultLines.length; i++) {
                        let result = parseSpaceDelimitedFormat(resultLines[i], i + 1 < resultLines.length ? resultLines[i + 1] : '');
                        if (result) {
                            extractedResults.push(result);
                        }
                    }
                } else if (hasRunHighPattern) {
                    // Process RunHigh format
                    for (let i = 0; i < resultLines.length; i++) {
                        let result = parseRunHighFormat(resultLines[i]);
                        if (result) {
                            extractedResults.push(result);
                        }
                    }
                } else if (hasKarmaRushPattern) {
                    // Process KarmaRush format
                    let i = 0;
                    while (i < resultLines.length) {
                        if (resultLines[i].match(/^\d+\t/)) {
                            let result = parseKarmaRushTabFormat(resultLines, i);
                            if (result) {
                                extractedResults.push(result);
                                i = result.nextIndex;
                            } else {
                                i++;
                            }
                        } else {
                            i++;
                        }
                    }
                } else if (hasMileSplitPattern) {
                    // Process MileSplit format
                    let i = 0;
                    while (i < resultLines.length) {
                        if (resultLines[i].match(/^(\d+|--)$/)) {
                            let result = parseMileSplitFormat(resultLines, i);
                            if (result) {
                                extractedResults.push(result);
                                i = result.nextIndex;
                            } else {
                                i++;
                            }
                        } else {
                            i++;
                        }
                    }
                } else if (hasRunSignupPattern) {
                    // Process RunSignup format
                    let i = 0;
                    while (i < resultLines.length) {
                        if (resultLines[i].match(/^\d+(\t|$)/)) {
                            let result = parseRunSignupFormat(resultLines, i);
                            if (result) {
                                extractedResults.push(result);
                                i = result.nextIndex;
                            } else {
                                i++;
                            }
                        } else {
                            i++;
                        }
                    }
                } else {
                    showError('Could not detect data format. Please ensure you copied the entire results table.');
                    document.getElementById('status').textContent = 'Error';
                    return;
                }

                if (extractedResults.length === 0) {
                    showError('Could not extract any valid results. Please check the format.');
                    document.getElementById('status').textContent = 'Error';
                    return;
                }

                displayResults();
                
                document.getElementById('rowCount').textContent = extractedResults.length;
                document.getElementById('platform').textContent = detectPlatform(input);
                document.getElementById('status').textContent = 'Complete';
                
                showToast(`Extracted ${extractedResults.length} results!`);
                
            } catch (error) {
                console.error('Extraction error:', error);
                showError('Error processing input. Please try again.');
                document.getElementById('status').textContent = 'Error';
            }
        }
        
        function parseEnduranceSplitsFormat(line) {
            // Format: "1    1    1164    Sofia Lauren Garza    Mission Sharyland    18:18.8    5:54/M"
            // Columns: O'All Place, Score, Bib No, Name, Team, Time, Pace
            // Skip lines with (< 5) or similar in score column

            // Split by tabs or multiple spaces (4+)
            const parts = line.trim().split(/\t|\s{4,}/).map(p => p.trim()).filter(p => p);

            if (parts.length < 6) return null;

            // First part should be a number (O'All Place)
            if (!parts[0].match(/^\d+$/)) return null;

            let partIndex = 0;

            // Skip O'All Place
            partIndex++;

            // Score (skip if contains < or > or parentheses)
            const score = parts[partIndex];
            if (score.includes('<') || score.includes('>') || score.includes('(')) {
                return null;
            }
            if (!score.match(/^\d+$/)) return null;
            partIndex++;

            // Bib number
            const bib = parts[partIndex];
            if (!bib.match(/^\d{3,4}$/)) return null;
            partIndex++;

            // Name
            const name = parts[partIndex];
            if (!name || name.length === 0) return null;
            partIndex++;

            // Team
            const team = parts[partIndex];
            if (!team || team.length === 0) return null;
            partIndex++;

            // Time
            const time = parts[partIndex];
            if (!time || !time.match(/\d+:\d+/)) return null;

            return {
                place: score,
                bib: bib,
                name: name,
                team: team,
                time: time,
                grade: '',
                points: '',
                pace: ''
            };
        }

        function parseSpaceDelimitedFormat(line, nextLine) {
            // Format: "1 EMILY GROSS (DUMA) DUMAS, TX F: 1 SO 1596 00:11:27.55 05:43 10.5mph :"
            // Or multi-line:
            // "1 CHRISTIAN VALENZUELA MIDLAND, TX M: 1 JR 2818 00:17:26.91..."
            // "(MILE)"

            // Try single-line format first (team in parentheses on same line)
            let match = line.match(/^(\d+)\s+([A-Z\s]+)\s*\(([A-Z]{3,4})\)\s*(.+?)\s+([MF])R?:\s*\d+\s+(FR|SO|JR|SR|8th|\d{1,2}th)\s+(\d+)\s+([\d:\.]+)/i);

            if (match) {
                // Clean up time - remove leading "00:" if present
                let time = match[8].trim();
                if (time.startsWith('00:')) {
                    time = time.substring(3);
                }

                return {
                    place: match[1].trim(),
                    name: match[2].trim(),
                    team: match[3].trim(),
                    grade: match[6].trim().toUpperCase(),
                    bib: match[7].trim(),
                    time: time,
                    points: '',
                    pace: ''
                };
            }

            // Try multi-line format (team on next line)
            match = line.match(/^(\d+)\s+([A-Z\s]+)\s+(.+?)\s+([MF])R?:\s*\d+\s+(FR|SO|JR|SR|8th|\d{1,2}th)\s+(\d+)\s+([\d:\.]+)/i);

            if (match && nextLine) {
                const teamMatch = nextLine.match(/^\(([A-Z]{3,4})\)/i);
                if (teamMatch) {
                    // Clean up time - remove leading "00:" if present
                    let time = match[7].trim();
                    if (time.startsWith('00:')) {
                        time = time.substring(3);
                    }

                    return {
                        place: match[1].trim(),
                        name: match[2].trim(),
                        team: teamMatch[1].trim(),
                        grade: match[5].trim().toUpperCase(),
                        bib: match[6].trim(),
                        time: time,
                        points: '',
                        pace: ''
                    };
                }
            }

            return null;
        }

        function parseRunHighFormat(line) {
            // RunHigh format: "  ID#  POINTS  PLACE  Name, Grade  Split  Time  Pace  Team"
            // After trim: "1668     1     1  Gabe Simkiss, 11..."
            if (!line.match(/^\d{3,4}\s+/)) {
                return null;
            }
            
            let result = {
                place: '',
                points: '',
                bib: '',
                name: '',
                grade: '',
                team: '',
                time: '',
                pace: ''
            };
            
            // Split by multiple spaces (2 or more)
            const parts = line.trim().split(/\s{2,}/).map(p => p.trim()).filter(p => p);
            
            if (parts.length < 5) return null;
            
            let partIndex = 0;
            
            // ID# (bib number)
            if (partIndex < parts.length && parts[partIndex].match(/^\d{3,4}$/)) {
                result.bib = parts[partIndex];
                partIndex++;
            }
            
            // POINTS
            if (partIndex < parts.length && parts[partIndex].match(/^\d+$/)) {
                result.points = parts[partIndex];
                partIndex++;
            }
            
            // PLACE
            if (partIndex < parts.length && parts[partIndex].match(/^\d+$/)) {
                result.place = parts[partIndex];
                partIndex++;
            }
            
            // Name with grade - format "FirstName LastName, Grade" or "FirstName LastName, Grade*" (asterisk for females)
            if (partIndex < parts.length) {
                const namePart = parts[partIndex];
                const nameMatch = namePart.match(/^(.+),\s*(\d{1,2})\*?$/);
                if (nameMatch) {
                    result.name = nameMatch[1].trim();
                    result.grade = nameMatch[2];
                    partIndex++;
                } else {
                    result.name = namePart;
                    partIndex++;
                }
            }
            
            // Skip split time
            if (partIndex < parts.length && parts[partIndex].match(/^\d{1,2}:\d{2}\.\d+$/)) {
                partIndex++;
            }
            
            // Final time
            if (partIndex < parts.length && parts[partIndex].match(/^\d{1,2}:\d{2}\.\d+$/)) {
                result.time = parts[partIndex];
                partIndex++;
            }
            
            // Pace
            if (partIndex < parts.length && parts[partIndex].match(/^\d{1,2}:\d{2}$/)) {
                result.pace = parts[partIndex];
                partIndex++;
            }
            
            // Team name
            if (partIndex < parts.length) {
                result.team = parts.slice(partIndex).join(' ').trim();
            }
            
            return (result.place && result.name && result.time) ? result : null;
        }
        
        function parseKarmaRushTabFormat(lines, startIndex) {
            let i = startIndex;
            let result = {
                place: '',
                points: '',
                bib: '',
                name: '',
                grade: '',
                team: '',
                time: '',
                pace: ''
            };
            
            const firstLine = lines[i].trim();
            const tabParts = firstLine.split('\t').map(p => p.trim());
            
            if (tabParts.length < 2) {
                return null;
            }
            
            result.place = tabParts[0];
            result.name = tabParts[1];
            i++;
            
            if (i < lines.length) {
                const schoolLine = lines[i].trim();
                const match = schoolLine.match(/^(.+?)\s*\[(\d{1,2}|fr|so|jr|sr)\]\s*-\s*(\d+)$/i);
                if (match) {
                    result.team = match[1].trim();
                    result.grade = match[2];
                    result.bib = match[3];
                }
                i++;
            }
            
            if (i < lines.length && lines[i].match(/^\d{1,2}:\d{2}\.\d/)) {
                result.time = lines[i].trim();
                i++;
            }
            
            if (i < lines.length && lines[i].includes('|')) {
                i++;
            }
            
            let pointsCollected = 0;
            while (i < lines.length && pointsCollected < 2) {
                if (lines[i].trim().match(/^\d+$/)) {
                    if (!result.points) {
                        result.points = lines[i].trim();
                    }
                    i++;
                    pointsCollected++;
                } else {
                    break;
                }
            }
            
            return result.time ? { ...result, nextIndex: i } : null;
        }

        function parseMileSplitFormat(lines, startIndex) {
            let i = startIndex;
            let result = {
                place: '',
                points: '',
                bib: '',
                name: '',
                grade: '',
                team: '',
                time: '',
                pace: ''
            };
            
            const placeLine = lines[i].trim();
            if (!placeLine.match(/^(\d+|--)$/)) {
                return null;
            }
            
            result.place = placeLine;
            i++;
            
            if (i < lines.length && lines[i].trim().match(/^Logo/i)) {
                i++;
            }
            
            if (i < lines.length) {
                const nameLine = lines[i].trim();
                if (!nameLine.match(/^(\d+|--|Logo)$/i)) {
                    result.name = nameLine;
                    i++;
                } else {
                    return null;
                }
            }
            
            if (i < lines.length) {
                const teamLine = lines[i].trim();
                if (!teamLine.match(/^(\d+|--|Logo)$/i)) {
                    const bibMatch = teamLine.match(/#(\d+)/);
                    if (bibMatch) {
                        result.bib = bibMatch[1];
                        result.team = teamLine.replace(/-\s*#\d+/, '').trim();
                    } else {
                        result.team = teamLine;
                    }
                    i++;
                }
            }
            
            if (i < lines.length) {
                const timeLine = lines[i].trim();
                if (timeLine.match(/^\d{1,2}:\d{2}\.\d{1,2}$/) || timeLine === '--') {
                    result.time = timeLine;
                    i++;
                }
            }
            
            if (i < lines.length) {
                const nextLine = lines[i].trim();
                if ((nextLine.match(/^\d+$/) || nextLine === '--') && i + 1 < lines.length) {
                    const lookAhead = i + 1 < lines.length ? lines[i + 1].trim() : '';
                    if (lookAhead.match(/^(Logo|\d+|--)/i) || i + 1 >= lines.length) {
                        result.points = nextLine;
                        i++;
                    }
                }
            }
            
            return result.name ? { ...result, nextIndex: i } : null;
        }

        function parseRunSignupFormat(lines, startIndex) {
            let i = startIndex;
            let result = {
                place: '',
                points: '',
                bib: '',
                name: '',
                grade: '',
                team: '',
                time: '',
                pace: ''
            };
            
            const placeLine = lines[i];
            const placeParts = placeLine.split(/\t/).filter(p => p);
            
            if (!placeParts[0] || !placeParts[0].match(/^\d+$/)) {
                return null;
            }
            
            result.place = placeParts[0];
            
            for (let j = 1; j < placeParts.length; j++) {
                const part = placeParts[j];
                if (part.match(/^\d+$/)) {
                    if (part.match(/^\d{3,4}$/) && !result.bib) {
                        result.bib = part;
                    } else if (!result.points) {
                        result.points = part;
                    }
                }
            }
            i++;
            
            if (i < lines.length && lines[i].match(/^[A-Z]$/)) {
                i++;
            }
            
            let firstName = '';
            let lastName = '';
            
            if (i < lines.length && lines[i].match(/^[A-Z][a-z]/)) {
                firstName = lines[i];
                i++;
            }
            
            if (i < lines.length && lines[i].match(/^[A-Z][a-z]/)) {
                lastName = lines[i];
                i++;
            }
            
            result.name = [firstName, lastName].filter(n => n).join(' ');
            
            if (i < lines.length && lines[i].includes('\t')) {
                const dataLine = lines[i];
                const parts = dataLine.split(/\t/).map(p => p.trim()).filter(p => p);
                
                let partIndex = 0;
                
                if (partIndex < parts.length && parts[partIndex].match(/^\d{1,2}$/)) {
                    const num = parseInt(parts[partIndex]);
                    if (num >= 7 && num <= 12) {
                        result.grade = parts[partIndex];
                        partIndex++;
                    }
                }
                
                let teamParts = [];
                while (partIndex < parts.length && !parts[partIndex].match(/^\d{1,2}:\d{2}/)) {
                    const part = parts[partIndex];
                    
                    if (!result.bib && part.match(/^\d{3,4}$/) && 
                        partIndex + 1 < parts.length && 
                        !parts[partIndex + 1].match(/^\d{1,2}:\d{2}/)) {
                        result.bib = part;
                    } else {
                        teamParts.push(part);
                    }
                    partIndex++;
                }
                
                let teamName = teamParts.join(' ');
                teamName = teamName.replace(/\s+\d+\s+\d+\s+\d+$/, '');
                teamName = teamName.replace(/\s+\d+\s+\d+$/, '');
                teamName = teamName.replace(/\s+\d+$/, '');
                teamName = teamName.replace(/\s*\([^)]*\)\s*$/, '');
                teamName = teamName.replace(/\s*<\s*\d+\s*Incomplete\s*\d*\s*$/, '');
                teamName = teamName.replace(/\s*<\s*\d+\s*$/, '');
                teamName = teamName.replace(/\s*>\s*\d*\s*$/, '');
                teamName = teamName.replace(/\s*>\s*$/, '');
                result.team = teamName.trim();
                
                if (partIndex < parts.length && parts[partIndex].match(/^\d{1,2}:\d{2}/)) {
                    result.time = parts[partIndex];
                }
                
                i++;
            }
            
            return result.name && result.time ? { ...result, nextIndex: i } : null;
        }

        function detectPlatform(text) {
            const lowerText = text.toLowerCase();
            if (lowerText.includes('karmarush')) return 'KarmaRush';
            if (lowerText.includes('milesplit') || text.includes('Logo') || text.match(/#\d+/)) return 'MileSplit';
            if (lowerText.includes('runsignup')) return 'RunSignup';
            if (lowerText.includes('runhigh') || text.match(/ID#\s+POINTS\s+FINISHER/)) return 'RunHigh';
            
            if (text.match(/^\s+\d{3,4}\s+\d+\s+\d+\s+[A-Z][a-z]+.*,\s*\d{1,2}\s+\d{1,2}:\d{2}\.\d+/m)) return 'RunHigh';
            if (text.match(/\[\d{1,2}\] - \d{3,4}/)) return 'KarmaRush';
            if (text.match(/^\d{1,3}\s{2,}\d{2,4}\s{2,}/m)) return 'PDF';
            if (text.match(/\t.*\t.*\d{1,2}:\d{2}\.\d/)) return 'RunSignup';
            
            return 'Auto-detected';
        }

        function displayResults() {
            const tbody = document.getElementById('tableBody');
            
            if (extractedResults.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <div class="empty-state-icon">üìã</div>
                            <div>No results yet. Paste race data above and click "Extract Results"</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = extractedResults.map((r, index) => {
                let placeClass = 'place-cell';
                if (r.place === '1') placeClass += ' gold';
                else if (r.place === '2') placeClass += ' silver';
                else if (r.place === '3') placeClass += ' bronze';
                
                return `
                    <tr>
                        <td class="${placeClass}">${r.place}</td>
                        <td class="bib-cell">${r.bib}</td>
                        <td class="name-cell">${r.name}</td>
                        <td style="text-align: center;">${r.grade}</td>
                        <td class="team-cell">${r.team}</td>
                        <td class="time-cell">${r.time}</td>
                    </tr>
                `;
            }).join('');
        }

        function copyAsSpreadsheet() {
            if (extractedResults.length === 0) {
                showToast('No results to copy');
                return;
            }
            
            const delimiter = document.getElementById('delimiter').value === 'csv' ? ',' : 
                            document.getElementById('delimiter').value === 'pipe' ? '|' : '\t';
            
            const header = ['Place', 'Bib', 'Name', 'Grade', 'Team', 'Time'].join(delimiter);
            const rows = extractedResults.map(r => 
                [r.place, r.bib, r.name, r.grade, r.team, r.time].join(delimiter)
            );
            
            const output = [header, ...rows].join('\n');
            
            copyToClipboard(output);
            showToast('Copied to clipboard!');
        }

        function copyTableData() {
            if (extractedResults.length === 0) {
                showToast('No results to copy');
                return;
            }
            
            const delimiter = '\t';
            
            const header = ['Place', 'Bib', 'Name', 'Grade', 'Team', 'Time'].join(delimiter);
            const rows = extractedResults.map(r => 
                [r.place, r.bib, r.name, r.grade, r.team, r.time].join(delimiter)
            );
            
            const output = [header, ...rows].join('\n');
            
            copyToClipboard(output);
            showToast('Table copied to clipboard!');
        }

        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
        }

        function clearAll() {
            document.getElementById('input').value = '';
            extractedResults = [];
            displayResults();
            document.getElementById('rowCount').textContent = '0';
            document.getElementById('platform').textContent = '-';
            document.getElementById('status').textContent = 'Ready';
            showToast('Cleared all data');
        }

        function loadSample() {
            const sampleData = `  ID#  POINTS        FINISHER          TIME       2.5K    
 1668     1     1  Gabe Simkiss, 11          8:11.2   16:13.7    5:14  Regina Luminis Acad.     
  509     2     2  Kendel Jones, 12          8:10.5   16:17.8    5:15  Elk Lake                 
  503     3     3  Cody Adams, 12            8:15.3   16:40.1    5:23  Elk Lake                 
 1720     4     4  Mikey Schimelfenig, 12    8:15.3   16:53.7    5:27  Riverside                
  512     5     5  Parker Upright, 11        8:19.1   16:58.5    5:29  Elk Lake`;
            
            document.getElementById('input').value = sampleData;
            showToast('Sample data loaded - click Extract Results');
        }
    </script>
</body>
</html>